---
title: "AMS Blanks"
author: "Brett Longworth"
date: "Jan 23, 2017"
output: html_document
---

Summary of AMS blanks (JME and C1) for both machines from Sep 2014 to present. Raw ratio data are from snics_raw, normalized and blank corrected values are from snics_results. I'm still working on pulling out acetanalides that were used as test samples, so for now I'm rejecting data Fm > 0.05. 

## Data getting and munging

```{r warning=FALSE, message=FALSE}
library(amstools)
library(RODBC)
library(dplyr)
library(ggplot2)
library(knitr)
#library(ggthemr)

#ggthemr("fresh")

from <- '2014-09-01'

#Open DB connection
db <- conNOSAMS()

#Get raw blank data
raw =  sqlQuery(db, paste("
      SELECT runtime, target.tp_date_pressed, target.rec_num, 
          sample_name, target.tp_num, gf_co2_qty, 
          he12c, he13c, d13c, he14_12, he13_12, wheel, ok_calc
        FROM snics_raw, target, graphite
      	WHERE target.tp_num = snics_raw.tp_num
        AND target.osg_num = graphite.osg_num
        AND tp_date_pressed > '", from, "'
        AND target.rec_num IN (83028, 2138, 140548, 36168)
        "))

jmer =  sqlQuery(db, paste("
      SELECT runtime, target.tp_date_pressed, target.rec_num, 
          sample_name, target.tp_num, he12c, he13c, d13c, he14_12, 
          he13_12, wheel, ok_calc
        FROM snics_raw, target
      	WHERE target.tp_num = snics_raw.tp_num
        AND tp_date_pressed > '", from, "'
        AND target.rec_num = 32491
        "))

#add type columns, combine data frames
jmer$gf_co2_qty <- NA
blanks.r <- rbind(raw, jmer)
#blanks.r$type <- ordered(blanks.r$type, levels = c("Acet", "C1", "TIRI-F", "JME"))

#average by target and filter
blanks.a <- blanks.r %>%
  #filter(ok_calc == 1) %>%
  group_by(tp_num) %>%
  summarize(
    he12c = mean(ifelse(ok_calc == 1, he12c, NA), na.rm = TRUE),
    he1412 = mean(ifelse(ok_calc == 1, he14_12, NA), na.rm = TRUE),
    flagged = ( (n() - sum(ok_calc == 1)) / n()) # fraction of runs flagged
  ) %>%
  mutate(c1412x = he1412 * 1e16) %>%
  filter(c1412x < 250) 

###
#Get normalized blank data
###

blanks.n =  sqlQuery(db, paste("
      SELECT runtime, wheel, target.tp_date_pressed, sample_name,
          target.rec_num, target.tp_num, gf_co2_qty, 
          norm_ratio, int_err, ext_err, 
          blk_corr_method, fm_corr, sig_fm_corr, ss
        FROM snics_results, target, graphite
        WHERE target.tp_num = snics_results.tp_num
        AND target.osg_num = graphite.osg_num
        AND tp_date_pressed > '", from, "'
        AND target.rec_num IN (83028, 2138, 140548, 36168)
        AND graphite.gf_co2_qty > 40
        "))


jme =  sqlQuery(db, paste("
       SELECT runtime, wheel, target.tp_date_pressed, sample_name, 
           target.rec_num, target.tp_num,
           norm_ratio, int_err, ext_err,
           blk_corr_method, fm_corr, sig_fm_corr, ss
         FROM snics_results, target
         WHERE target.tp_num = snics_results.tp_num
         AND target.rec_num = 32491
        AND tp_date_pressed > '", from, "'
         "))

#Close DB
odbcClose(db)

jme$gf_co2_qty <- NA
blanks.n <- rbind(blanks.n, jme)


#combine data


blanks <- left_join(blanks.a, blanks.n, by="tp_num") %>%
  mutate(tp_date_pressed = as.Date(tp_date_pressed),
         type = recode(as.character(rec_num), 
                               "83028" = "C1", 
                               "2138" = "TIRI-F", 
                               "36168" = "Acet", 
                               "140548" = "Acet",
                               "32491" = "JME"),
         merr = pmax(int_err, ext_err),
         system = substring(wheel, 1, 5)) %>%
 filter(norm_ratio < .05, 
        norm_ratio > -99, 
        fm_corr <.05) 
#Export data as CSV
write.csv(blanks, "blanks.csv")
```


## Summary

Raw data (Raw1412, Raw1412.sd) are means by target of accepted (unflagged) points. Points above 1e-14 removed. normFm, normFm.sd, and normFm.err are the mean normalized Fm, standard deviation of norm Fm, and mean reported error of normalized blanks. BlkCorrFm is the mean blank Fm after normalization and blank correction. This should distribute around 0.

### Summary table

```{r, echo=FALSE, warning=FALSE}

blanksum <- blanks %>%
  group_by(system, type) %>%
  summarize(
    Raw1412 = mean(c1412x, na.rm = TRUE),
    Raw1412.sd = sd(c1412x, na.rm = TRUE),
    normFm = mean(norm_ratio),
    normFm.sd = sd(norm_ratio),
    normFm.err = mean(merr),
    N = n())
kable(blanksum, digits = c(0,0,2,3,4,5,5,6,0))
```

### Boxplots by system and sample type for all data.

```{r echo=FALSE, warning=FALSE}
ggplot(blanks, aes(x = system, y = c1412x)) + 
  geom_boxplot() + facet_grid(. ~ type) + 
  xlab("System") + ylab("Average Raw 14/12 ratio") +
  ylab(expression(paste("Raw 14/12 ratio ( X", 10^{-16},")"))) +
  theme_bw() + theme(panel.grid.minor=element_blank(), panel.grid.major=element_blank())

ggplot(blanks, aes(x = system, y = norm_ratio)) + 
  geom_boxplot() + facet_grid(. ~ type) + 
  xlab("System") + ylab("Average Normalized Fm") +
  #ylab(expression(paste("Raw 14/12 ratio ( X", 10^{-16},")"))) +
  theme_bw() + theme(panel.grid.minor=element_blank(), panel.grid.major=element_blank())
```

### Variability of blanks over time.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(blanks, aes(tp_date_pressed, c1412x, color = system)) +
  scale_y_log10() + geom_smooth() + facet_grid(type ~ ., scale = "free") + 
  geom_point() + theme_bw() + 
  theme(panel.grid.minor=element_blank(), panel.grid.major=element_blank())

ggplot(blanks, aes(tp_date_pressed, norm_ratio, color = system)) +
  geom_smooth() + facet_grid(type ~ ., scale = "free") +  theme_bw() + 
  geom_point() + 
  theme(panel.grid.minor=element_blank(), panel.grid.major=element_blank())
```

### Flagging

#### By system
```{r echo=FALSE, warning=FALSE}
ggplot(blanks, aes(x = system, y = flagged)) + 
  geom_violin() + facet_grid(. ~ type) + 
  xlab("System") + ylab("Fraction of runs flagged") +
  theme_bw() + theme(panel.grid.minor=element_blank(), panel.grid.major=element_blank())
```

#### Over time

```{r, echo=FALSE, warning=FALSE, message=FALSE}
qplot(tp_date_pressed, flagged, color = system, data = blanks) +
  geom_smooth() + facet_grid(type ~ ., scale = "free") +  theme_bw() + 
  theme(panel.grid.minor=element_blank(), panel.grid.major=element_blank())
```


